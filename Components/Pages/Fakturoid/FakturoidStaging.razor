@page "/fakturoid/staging"
@rendermode InteractiveServer
@attribute [Authorize]
@using System.Security.Claims
@using Isdocovac.Services.Fakturoid
@using Isdocovac.Services
@using Isdocovac.Providers
@using Isdocovac.Models
@using Isdocovac.Utils
@inject IFakturoidConnectionProvider ConnectionProvider
@inject IFakturoidInvoiceProvider InvoiceProvider
@inject IFakturoidOAuthService OAuthService
@inject IFakturoidSyncService SyncService
@inject IFakturoidOAuthStateProvider OAuthStateProvider
@inject IInvoiceImportService InvoiceImportService
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration

<PageTitle>Fakturoid Import - Isdocovac</PageTitle>

<div class="container mt-4">
    <h2>Fakturoid Invoice Import</h2>
    <p class="text-muted">Review and import invoices from your Fakturoid account</p>

    @if (isLoading)
    {
        <div class="text-center mt-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading...</p>
        </div>
    }
    else if (!isConnected)
    {
        <div class="card mt-4">
            <div class="card-body text-center">
                <h4>Connect Your Fakturoid Account</h4>
                <p class="text-muted">To import invoices, please connect your Fakturoid account.</p>
                <button class="btn btn-primary" @onclick="ConnectToFakturoid">
                    Connect to Fakturoid
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="badge bg-success">Connected</span>
                @if (syncStatus != null && syncStatus.LastSyncedAt.HasValue)
                {
                    <span class="text-muted ms-2">Last synced: @syncStatus.LastSyncedAt.Value.ToString("g")</span>
                }
            </div>
            <div>
                <button class="btn btn-outline-primary" @onclick="SyncInvoices" disabled="@isSyncing">
                    @if (isSyncing)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        <span>Syncing...</span>
                    }
                    else
                    {
                        <span>Sync from Fakturoid</span>
                    }
                </button>
                <button class="btn btn-outline-danger ms-2" @onclick="DisconnectFromFakturoid">
                    Disconnect
                </button>
            </div>
        </div>

        <div class="mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn @(!showImportedOnly ? "btn-primary" : "btn-outline-primary")"
                        @onclick="() => ToggleImportedFilter(false)">
                    Show All
                </button>
                <button type="button" class="btn @(showImportedOnly ? "btn-primary" : "btn-outline-primary")"
                        @onclick="() => ToggleImportedFilter(true)">
                    Show Unimported Only
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="alert alert-info" role="alert">
                @statusMessage
            </div>
        }

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Number</th>
                        <th>Date</th>
                        <th>Client</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Sync Status</th>
                        <th>Import Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (invoices != null && invoices.Any())
                    {
                        @foreach (var invoice in invoices)
                        {
                            <tr>
                                <td>@invoice.Number</td>
                                <td>@invoice.IssuedOn?.ToString("d")</td>
                                <td>@invoice.ClientName</td>
                                <td>@invoice.Total.ToString("N2") @invoice.Currency</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(invoice.Status)">
                                        @invoice.Status
                                    </span>
                                </td>
                                <td>
                                    @if (invoice.FakturoidUpdatedAt.HasValue && invoice.LastSyncedAt < invoice.FakturoidUpdatedAt)
                                    {
                                        <span class="badge bg-warning">Updated on Fakturoid</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Up to date</span>
                                    }
                                </td>
                                <td>
                                    @if (invoice.IsImported)
                                    {
                                        <span class="badge bg-success">Imported</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Not Imported</span>
                                    }
                                </td>
                                <td>
                                    @if (invoice.IsImported && invoice.ImportedInvoiceId.HasValue)
                                    {
                                        <a href="/invoices/@invoice.ImportedInvoiceId" class="btn btn-sm btn-primary">
                                            View Invoice
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-success"
                                                @onclick="() => ImportInvoice(invoice.Id)"
                                                disabled="@importingInvoices.Contains(invoice.Id)">
                                            @if (importingInvoices.Contains(invoice.Id))
                                            {
                                                <span class="spinner-border spinner-border-sm me-1"></span>
                                                <span>Importing...</span>
                                            }
                                            else
                                            {
                                                <span>Import</span>
                                            }
                                        </button>
                                    }
                                    @if (!string.IsNullOrEmpty(invoice.HtmlUrl))
                                    {
                                        <a href="@invoice.HtmlUrl" target="_blank" class="btn btn-sm btn-outline-primary ms-1">
                                            Fakturoid
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                @if (showImportedOnly)
                                {
                                    <span>All invoices have been imported. Switch to "Show All" to see them.</span>
                                }
                                else
                                {
                                    <span>No invoices found. Click "Sync from Fakturoid" to import invoices.</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (totalPages > 1)
        {
            <nav>
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => LoadPage(currentPage - 1)">Previous</button>
                    </li>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        var pageNumber = i;
                        <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                            <button class="page-link" @onclick="() => LoadPage(pageNumber)">@pageNumber</button>
                        </li>
                    }
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => LoadPage(currentPage + 1)">Next</button>
                    </li>
                </ul>
            </nav>
        }
    }
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationStateTask { get; set; }

    private bool isLoading = true;
    private bool isConnected = false;
    private bool isSyncing = false;
    private bool showImportedOnly = false;
    private string? statusMessage;
    private Guid userId;
    private FakturoidConnection? connection;
    private List<FakturoidInvoice>? invoices;
    private SyncResult? syncStatus;
    private int currentPage = 1;
    private int pageSize = 40;
    private int totalPages = 1;
    private HashSet<Guid> importingInvoices = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateTask!;
        var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);

        if (userIdClaim == null)
        {
            NavigationManager.NavigateTo("/auth/login");
            return;
        }

        userId = Guid.Parse(userIdClaim.Value);
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;

        connection = await ConnectionProvider.GetByUserIdAsync(userId);
        isConnected = connection != null && connection.IsActive;

        if (isConnected)
        {
            syncStatus = await SyncService.GetSyncStatusAsync(userId);
            await LoadPage(currentPage);

            if (syncStatus != null)
            {
                totalPages = (int)Math.Ceiling(syncStatus.TotalInvoices / (double)pageSize);
            }
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadPage(int page)
    {
        if (connection == null || page < 1 || page > totalPages)
            return;

        currentPage = page;

        if (showImportedOnly)
        {
            invoices = (await InvoiceProvider.GetUnimportedByConnectionIdAsync(connection.Id, page, pageSize)).ToList();
        }
        else
        {
            invoices = (await InvoiceProvider.GetByConnectionIdAsync(connection.Id, page, pageSize)).ToList();
        }

        StateHasChanged();
    }

    private async Task ToggleImportedFilter(bool showUnimportedOnly)
    {
        showImportedOnly = showUnimportedOnly;
        currentPage = 1;
        await LoadPage(currentPage);
    }

    private async Task ConnectToFakturoid()
    {
        var state = SecureTokenGenerator.GenerateToken(16);
        var stateHash = TokenHasher.HashToken(state);
        var expiresAt = DateTime.UtcNow.AddMinutes(10);
        await OAuthStateProvider.StoreAsync(userId, stateHash, expiresAt);
        var authUrl = OAuthService.GetAuthorizationUrl(state);
        NavigationManager.NavigateTo(authUrl, forceLoad: true);
    }

    private async Task SyncInvoices()
    {
        isSyncing = true;
        statusMessage = "Syncing invoices from Fakturoid...";
        StateHasChanged();

        try
        {
            var syncedCount = await SyncService.SyncInvoicesAsync(userId, fullSync: false);
            statusMessage = $"Successfully synced {syncedCount} invoice(s).";
            await LoadData();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error syncing invoices: {ex.Message}";
        }

        isSyncing = false;
        StateHasChanged();
    }

    private async Task ImportInvoice(Guid fakturoidInvoiceId)
    {
        importingInvoices.Add(fakturoidInvoiceId);
        StateHasChanged();

        try
        {
            var invoice = await InvoiceImportService.ImportFromFakturoidAsync(fakturoidInvoiceId, userId);
            statusMessage = $"Successfully imported invoice {invoice.Number}";
            await LoadPage(currentPage);
        }
        catch (Exception ex)
        {
            statusMessage = $"Error importing invoice: {ex.Message}";
        }
        finally
        {
            importingInvoices.Remove(fakturoidInvoiceId);
            StateHasChanged();
        }
    }

    private async Task DisconnectFromFakturoid()
    {
        if (connection == null)
            return;

        try
        {
            await ConnectionProvider.DisconnectAsync(connection.Id);
            await OAuthService.RevokeTokenAsync(connection.AccessToken, connection.RefreshToken);
            await LoadData();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error disconnecting: {ex.Message}";
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "paid" => "bg-success",
            "overdue" => "bg-danger",
            "sent" => "bg-info",
            "open" => "bg-warning",
            "cancelled" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
